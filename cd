#!/bin/bash
APP_NAME="cd"
APP_DESCRIPTION="Extends builtin cd-command with traverseable history."
APP_DIR=${BASH_SOURCE%/*}
APP_VERSION="0.1"
APP_AUTHOR="rednammoc"
APP_AUTHOR_EMAIL="rednammoc@gmx.de"

# Load bash-utils core.
if [[ ! -d "$APP_DIR" ]]; then APP_DIR="$PWD"; fi
BASH_UTILS_DIR="${APP_DIR}/lib/bash-utils/src/utils"
source "${BASH_UTILS_DIR}/core_utils.sh"

# Require utils.
require "list_utils.sh"
require "cd_history"

function cd
{
	if [ "$1" == "-" ] || [ "$1" == "+" ]
	then
		cd_history "$1"
	else
		local lwd=$(pwd)
		if [ -z "$1" ] ; then builtin cd; else builtin cd "$1"; fi
		local cwd=$(pwd)
		if [ "${lwd}" != "${cwd}" ]
		then
			local list=$(cd_history_list_get)
			local list_size=$(list_size "${list}")
			local pos=$(expr $(cd_history_pos_cur "${list}") + 1)
			# When history is empty add the starting directory as well.
			[ ${list_size} -eq 0 ] && list_put "${list}" "${lwd}" && list_size=$(expr ${list_size} + 1) && pos=$(expr ${pos} + 1)
			# Add current directory to history and preserve order.
			list_put "${list}" "${cwd}" "${pos}"	
			# Remove first entry as long as history is greater than max-size.
			while [ ${list_size} -gt ${CD_HISTORY_SIZE_MAX} ]
			do
				list_delete "${list}" "1"
				list_size=$(expr ${list_size} - 1)
			done
			cd_history_pos_set "${list}" "${pos}"
		fi
	fi
}
