#!/bin/bash
source "list_utils.sh"
CD_HISTORY_BASE="$HOME/.cd_history"
CD_HISTORY_POS=()
CD_HISTORY_SIZE_MAX=100
CD_HISTORY_SEP_BY_TERM=true

function cd
{
	local list=$(cd_history_get_list)
	if [ "$1" == "-h" ]
	then
		list_enumerate "${list}"
	elif [ "$1" == "-r" ]
	then
		local index="$2"
		if [ "${index}" -gt 0 ] && [ "${index}" -lt $(list_size "${list}") ] ; then
			CD_HISTORY_POS[$$]=$index
			local entry=$(list_get "${list}" "${index}")
			[ $? ] && builtin cd "${entry}"
		fi
	elif [ "$1" == "-" ]
	then
		local index=$(cd_history_get_pos "${list}" $$)
		if [ "${index}" -gt 1 ]
		then
			index=$(expr ${index} - 1)
			cd -r "${index}"
		fi
	elif [ "$1" == "+" ]
	then
		local index=$(cd_history_get_pos "${list}" $$)
		local size=$(list_size "${list}")
		if [ ${index} -lt ${size} ] 
		then
			index=$(expr ${index} + 1)
			cd -r "${index}"
		fi
	else
		local lwd=$(pwd)
		builtin cd "$1"
		local cwd=$(pwd)
		if [ "${lwd}" != "${cwd}" ]
		then
			# Add directory to list and remove first entry as long as index max-size is reached.
			list_put "${list}" "${lwd}"		
			while [ $(list_size "${list}") -gt "${CD_HISTORY_SIZE_MAX}" ]
			do
				list_delete "${list}" "1"
			done
		fi
	fi
}

function cd_history_get_pos
{
	local list="$1"
	local index="$2"
	local entry="${CD_HISTORY_POS[$index]}"
	local pos=1
	# when no entry defined ...
	if [ -z "${entry}" ] ; then
		# check if history file exists ...
		if [ -f "${list}" ] ; then
			# and set pos to end of list.
			pos=$(list_size "${list}")
		fi
	else pos="$entry"; fi
	echo ${pos}
}

function cd_history_get_list
{
	local list=${CD_HISTORY_BASE}
	[ "${CD_HISTORY_SEP_BY_TERM}" ] && list="${CD_HISTORY}.$$"
	echo "${list}"
}
